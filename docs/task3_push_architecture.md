Задание 3. Архитектура PUSH-уведомлений (верхний уровень)

Цель:
Отправлять PUSH в мобильное приложение (брошенная корзина, отмена заказа, маркетинг и др.).
Бэкенд — микросервисы.

============================================================
1) Верхнеуровневая блок-схема
```

+---------------------------+         +---------------------------+
|      Мобильное приложение |         |   Провайдеры PUSH         |
|      (iOS / Android)      |         |   (APNs / FCM)            |
+-------------+-------------+         +-------------+-------------+                                  ^
              | 1) регистрация push-токена        | 5) доставка PUSH
              v                                   |
+---------------------------+        4) отправка  |
|   Шлюз API / BFF          +---------------------+
|   (API Gateway / BFF)     |
+-------------+-------------+
              | 2) сохранить/обновить токены
              v
+---------------------------+      +---------------------------+
| Сервис токенов устройств   |----->| База токенов              |
| (Device Token Service)     |      | (Token DB: user -> tokens)|
+---------------------------+      +---------------------------+

      3) доменные события (микросервисы публикуют события)
+-------------------+     +-------------------+     +--------------------+
| Сервис корзины     |     | Сервис заказов    |     | Маркетинг/рассылки  |
| (Cart Service)     |     | (Order Service)   |     | (Marketing Service) |
+---------+---------+     +---------+---------+     +----------+---------+
           \                   |                       /
            v                  v                      v
                +-----------------------------------+
                | Брокер сообщений / очередь         |
                | (Message Broker / Queue)           |
                | Kafka / RabbitMQ / SQS             |
                +------------------+----------------+
                                   | чтение событий + применение правил
                                   v
                +-----------------------------------+
                | Сервис уведомлений                 |
                | (Notification Service)             |
                | - правила отправки                 |
                | - шаблоны текста                   |
                | - согласия пользователя            |
                | - защита от дублей/ретраи          |
                +------------------+----------------+
                                   | сформировать payload
                                   v
                +-----------------------------------+
                | Адаптер PUSH                       |
                | (Push Adapter: клиент APNs/FCM)    |
                +-----------------------------------+
```
============================================================
2) Два типовых сценария

2.1 Событийное уведомление: «Отмена заказа»
1) Сервис заказов публикует событие order_cancelled.
2) Событие попадает в брокер сообщений.
3) Сервис уведомлений:
   - проверяет настройки/согласия пользователя,
   - формирует текст по шаблону,
   - получает токены устройств пользователя.
4) Адаптер PUSH отправляет в APNs/FCM -> приложение получает PUSH.

2.2 Уведомление по времени: «Брошенная корзина»
Вариант (простой и понятный):
1) Сервис корзины хранит время последнего действия (last_activity_at).
2) Планировщик/задача (Scheduler/Job) периодически находит корзины без действий X минут.
3) Публикует событие cart_abandoned.
4) Дальше отправка как в 2.1.

============================================================
3) Что важно учесть (минимум для “прод”)

- Согласия и настройки: маркетинговые PUSH — только при согласии пользователя.
- Защита от дублей: у уведомления должен быть ключ (например: user_id + тип + order_id).
- Повторы и ошибки: при временных ошибках делаем retry; после N попыток — в “мертвую очередь” (DLQ).
- Жизненный цикл токена: если токен невалиден — помечаем его неактивным и не используем дальше.
- Наблюдаемость: логи отправок + метрики (успех/ошибка/время обработки).

============================================================
4) Вопросы к продукту / бизнес-заказчику

1) Какие типы PUSH нужны на MVP: заказ / корзина / маркетинг?
2) Нужны ли “тихие часы” для маркетинговых уведомлений?
3) Требования по скорости: уведомления по заказу должны приходить за секунды или допустимы минуты?
4) Нужна ли аналитика: доставлено/открыто (события для продуктовой аналитики)?
